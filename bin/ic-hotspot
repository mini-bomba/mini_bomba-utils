#! /bin/bash
#    ic-hotspot: a commandline utility to log into PKP InterCity's hotspot network
#
#    Copyright (C) 2024 mini_bomba
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <https://www.gnu.org/licenses/>.
echo "Making initial http request"
mkdir /tmp/ic_hotspot
curl -L -c /tmp/ic_hotspot/cookies -b "" --connect-to "hotspot.intercity.pl::10.231.0.1:" --dump-header /tmp/ic_hotspot/headers1 -o /tmp/ic_hotspot/output1 http://1.1.1.1
echo
if [[ $? -ne 0 ]];
then
  echo "Failed"
  exit 1
fi
if grep "cloudflare" /tmp/ic_hotspot/headers1 > /dev/null;
then
  echo "Already connected!"
  exit 1
fi
if grep "404 Not Found" /tmp/ic_hotspot/headers1 > /dev/null;
then
  echo "Got 404, retry"
  exit 1
fi
CSRF_TOKEN=`grep "csrfmiddlewaretoken" /tmp/ic_hotspot/output1 | grep -Po 'value="\w+' | cut -f 2 -d '"'`
if [[ -z "$CSRF_TOKEN" ]];
then
  echo "No CSRF token found";
  exit 1
fi

echo "Sending request #2"
curl -L -b /tmp/ic_hotspot/cookies --connect-to "hotspot.intercity.pl::10.231.0.1:" -F "csrfmiddlewaretoken=$CSRF_TOKEN" -F "form_type=terms" -F "accept_terms=1" -H "Referer: https://hotspot.intercity.pl:8443" -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:132.0) Gecko/20100101 Firefox/132.0" -o /tmp/ic_hotspot/output2 https://hotspot.intercity.pl:8443/cc/hotspot_pesa/index

HOST=`grep "host" /tmp/ic_hotspot/output2 | grep -Po '\d+\.\d+\.\d+\.\d+'`
PORT=`grep "port" /tmp/ic_hotspot/output2 | grep -Po '\d+'`
CHALLENGE=`grep "challenge" /tmp/ic_hotspot/output2 | grep -Po '[0-9a-f]{32}'`
USERNAME=`grep "\.logon" /tmp/ic_hotspot/output2 | cut -d '"' -f 2`
PASSWORD=`grep "\.logon" /tmp/ic_hotspot/output2 | cut -d '"' -f 4`

echo

if [[ -z "$HOST" ]] || [[ -z "$PORT" ]] || [[ -z "$CHALLENGE" ]] || [[ -z "$USERNAME" ]] || [[ -z "$PASSWORD" ]];
then
  echo "Failed to extract challenge data"
  exit 1
fi
echo "Sending request #3"
curl --connect-to "hotspot.intercity.pl::10.231.0.1:" "http://hotspot.intercity.pl:8080/cc/hotspot_pesa/_uamservice?username=$USERNAME&password=$PASSWORD&challenge=$CHALLENGE" | tee /tmp/ic_hotspot/output3

RESPONSE=`cat /tmp/ic_hotspot/output3`

echo
if [[ -z "$RESPONSE" ]];
then
  echo "Failed to extract challenge response"
  exit 1
fi
echo "Authenticating..."
curl "http://$HOST:$PORT/json/logon?username=$USERNAME&response=$RESPONSE"
echo
echo "Checking internet connectivity"
curl --dump-header /tmp/ic_hotspot/headers4 http://1.1.1.1
if ! grep "cloudflare" /tmp/ic_hotspot/headers4 > /dev/null;
then
  echo "Failed to authenticate!"
  exit 1
fi
echo "Done!"
rm -rf /tmp/ic_hotspot
